services:
  apisix:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    user: root
    dns:
      - 8.8.8.8
      - 8.8.4.4
    volumes:
      - ./apisix_conf/config.yaml:/usr/local/apisix/conf/config.yaml:ro
      - ./tmp:/tmp:rw  # 共享 Unix Socket 目录
    depends_on:
      - etcd
      - java-plugin-runner
    ports:
      - "9180:9180"   # Admin API
      - "9080:9080"   # HTTP 网关
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - apisix
    environment:
      - APISIX_DEPLOYMENT_ETCD_HOST=["http://etcd:2379"]

  java-plugin-runner:
    build:
      context: .
      dockerfile: Dockerfile.runner
    restart: always
    volumes:
      - ./tmp:/tmp:rw  # 共享 Unix Socket 目录
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - apisix
    environment:
      - SPRING_DATA_REDIS_HOST=host.docker.internal
      - SPRING_DATA_REDIS_PORT=6379
      - SPRING_DATA_REDIS_PASSWORD=redis123
    # 可选：启用远程调试
    # ports:
    #   - "5005:5005"
    # environment:
    #   - JAVA_TOOL_OPTIONS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
  
  etcd:
    image: openeuler/etcd:latest
    platform: linux/arm64
    restart: always
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ENABLE_V2=true
      - ETCD_DATA_DIR=/etcd-data
    volumes:
      - etcd-data:/etcd-data
    networks:
      - apisix

volumes:
  etcd-data:

networks:
  apisix:
    driver: bridge